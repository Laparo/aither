# Feature Specification: Course Slides

**Feature Branch**: `002-course-slides`  
**Created**: 2026-02-12  
**Status**: Complete  
**Input**: User description: "Fetch the next upcoming course from the Hemera API, generate HTML slides for intro, curriculum, and course material, and save them as numbered HTML files."

## Out of Scope

- Slide navigation or presentation mode (handled by the Full-Screen HTML Player, Constitution VIII).
- PDF export or conversion of slides.
- Incremental sync / caching of slides (all slides are regenerated on every invocation).
- Custom template authoring (slides use a fixed layout generated by Aither).

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Generate Intro Slide for Next Course (Priority: P1)

As a system operator, I want Aither to automatically determine the next upcoming course from the Hemera API and generate an intro slide with the course name and dates, so that presentation material is ready before the course starts.

**Why this priority**: The intro slide is the entry point for every course presentation. Without identifying the correct course and generating the intro, no other slides can be produced.

**Independent Test**: Can be fully tested by triggering slide generation and verifying that `01_intro.html` exists in `output/slides/` with the correct course name and dates.

**Acceptance Scenarios**:

1. **Given** the Hemera API contains future seminars, **When** slide generation is triggered, **Then** the system identifies the seminar whose start date is next in the future and generates `01_intro.html` with the course name centered on the page.
2. **Given** the identified seminar has a start date and a different end date, **When** the intro slide is generated, **Then** both dates are displayed in human-readable German format (de-CH locale).
3. **Given** the identified seminar starts and ends on the same day, **When** the intro slide is generated, **Then** only the start date is displayed (no redundant end date).
4. **Given** no future seminars exist in the Hemera API, **When** slide generation is triggered, **Then** the system returns an error indicating no upcoming course was found.

---

### User Story 2 — Generate Curriculum Slides (Priority: P1)

As a system operator, I want Aither to generate one HTML slide per curriculum item (lesson) of the next course, so that the course structure is available as presentation material.

**Why this priority**: The curriculum slides provide the structural overview of the course. Together with the intro slide, they form the minimum viable presentation.

**Independent Test**: Can be fully tested by triggering slide generation and verifying that `02_curriculum_{n}.html` files exist for each lesson, sorted by sequence.

**Acceptance Scenarios**:

1. **Given** the next course has 5 lessons, **When** slide generation is triggered, **Then** 5 curriculum slides are generated (`02_curriculum_1.html` through `02_curriculum_5.html`), each containing the lesson title centered on the page.
2. **Given** lessons are returned from the API in arbitrary order, **When** curriculum slides are generated, **Then** they are numbered according to the lesson `sequence` field, not API response order.
3. **Given** the API returns lessons for multiple seminars, **When** curriculum slides are generated, **Then** only lessons belonging to the identified next course are included.

---

### User Story 3 — Generate Course Material Slides (Priority: P2)

As a system operator, I want Aither to generate HTML slides for each piece of course material (text content, images, videos) linked to each lesson, so that the full course content is available as presentation material.

**Why this priority**: Material slides complete the presentation but depend on the curriculum structure (P1) being in place first. The course can be presented with just intro + curriculum slides in a minimal scenario.

**Independent Test**: Can be fully tested by triggering slide generation and verifying that `03_material_{lessonSeq}_{idx}.html` files exist with correct content for each material item.

**Acceptance Scenarios**:

1. **Given** lesson 1 has 2 text content items and 1 image, **When** material slides are generated, **Then** 3 slides are created: `03_material_1_1.html`, `03_material_1_2.html`, `03_material_1_3.html`.
2. **Given** a material item is a text content block, **When** its slide is generated, **Then** the text body is rendered as HTML centered on the page.
3. **Given** a material item is an image, **When** its slide is generated, **Then** an `<img>` tag with the source URL and alt text is rendered centered on the page.
4. **Given** a material item is a video, **When** its slide is generated, **Then** a `<video>` tag with playback controls is rendered centered on the page.
5. **Given** materials span multiple lessons, **When** slides are generated, **Then** materials are ordered by lesson sequence first, then by material index within each lesson.

---

### User Story 4 — Trigger Slide Generation via API (Priority: P2)

As a system operator, I want to trigger slide generation via a dedicated API endpoint, so that I can generate slides on demand (e.g., before a course starts).

**Why this priority**: A dedicated trigger mechanism is needed for operational use but depends on the slide generation logic (P1) being in place first.

**Independent Test**: Can be fully tested by sending a POST request to `/api/slides` and verifying that slides are generated in `output/slides/`.

**Acceptance Scenarios**:

1. **Given** the system is running and the Hemera API is reachable, **When** a POST request is sent to `/api/slides`, **Then** the system generates all slides and returns a success response with the number of slides generated.
2. **Given** slide generation is already in progress, **When** another POST request is sent to `/api/slides`, **Then** the system returns 409 Conflict.
3. **Given** the user is not authenticated or not an admin, **When** a POST request is sent to `/api/slides`, **Then** the system returns 401/403.

---

### Edge Cases

- What happens when the Hemera API is temporarily unavailable? The system retries with exponential backoff (reuses HemeraClient from Spec 001) and returns an error if all retries fail.
- What happens when a lesson has no associated course material? No material slides are generated for that lesson; curriculum slide is still generated.
- What happens when the API returns no lessons for the identified course? Only the intro slide is generated; a warning is logged.
- What happens when a media URL from hemera.academy is invalid or unreachable? The slide is still generated with the URL as-is; the HTML will show a broken image/video (graceful degradation at display time).
- What happens when the `output/slides/` directory contains slides from a previous run? The directory is cleared before generating new slides.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST fetch all seminars from the Hemera API and identify the seminar whose start date is the next one in the future.
- **FR-002**: System MUST generate an intro slide (`01_intro.html`) containing the course name and formatted dates (start date always; end date only if different from start date). Dates MUST be formatted in German (de-CH locale) using `Intl.DateTimeFormat`.
- **FR-003**: System MUST fetch lessons for the identified course and generate one curriculum slide per lesson (`02_curriculum_{sequence}.html`), sorted by the lesson `sequence` field.
- **FR-004**: System MUST fetch text content and media assets for each lesson and generate one material slide per item (`03_material_{lessonSequence}_{materialIndex}.html`).
- **FR-005**: System MUST support client-side filtering of API responses (lessons by `seminarId`, texts/media by `entityRef`) as a fallback if the Hemera API does not support server-side query parameters. Server-side filtering SHOULD be used if available.
- **FR-006**: System MUST clear the `output/slides/` directory before generating new slides. The directory MUST be created automatically if it does not exist.
- **FR-007**: All generated slides MUST use a consistent HTML layout optimized for 1920×1080 (Full HD) resolution with centered content and CSS custom properties for future branding.
- **FR-008**: System MUST expose a dedicated API endpoint (`POST /api/slides`) to trigger slide generation, separate from the data sync endpoint.
- **FR-009**: The slides endpoint MUST require Clerk authentication with admin role (consistent with Spec 001 access control).
- **FR-010**: System MUST prevent concurrent slide generation using a mutex (return 409 Conflict if already running).
- **FR-011**: System MUST reuse the existing `HemeraClient` from Spec 001 for all API calls (throttling, retry, auth).

### Key Entities

- **SlideJob**: Represents a single slide generation execution (transient, in-memory). Key attributes: job ID, start time, end time, status (running/success/failed), slides generated count, errors.
- **Seminar**: Reused from Spec 001 — course offering with title, dates, lesson references.
- **Lesson**: Reused from Spec 001 — individual lesson with title, sequence, content references.
- **TextContent**: Reused from Spec 001 — text content block associated with a lesson.
- **MediaAsset**: Reused from Spec 001 — image or video metadata associated with a lesson.

## Clarifications

### Session 2026-02-12

- Q: Does the Hemera API support query parameters for filtering lessons by seminarId? → A: Unknown — implement client-side filtering as fallback; use server-side filtering if available.
- Q: How should slide generation be triggered? → A: Dedicated `POST /api/slides` endpoint, separate from the sync pipeline.
- Q: Should slides use specific branding/CSS? → A: Minimal centered layout with CSS custom properties for future branding.
- Q: Should slides be optimized for a specific resolution? → A: Yes, 1920×1080 (Full HD) for projection use.

## Assumptions

- The Hemera API provides seminar, lesson, text content, and media asset data as defined in Spec 001.
- The existing `HemeraClient`, Zod schemas, and entity types from Spec 001 are available and functional.
- Slide generation is a separate concern from data synchronization — slides are generated on demand, not as part of the daily sync.
- The `output/slides/` directory is gitignored (consistent with `output/` from Spec 001).
- Slides are static HTML files — no JavaScript, no interactivity. Navigation between slides is handled by the Full-Screen HTML Player (Constitution VIII, future feature).
- The number of slides per course is in the low tens to low hundreds (manageable without pagination or streaming).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% of lessons and course materials for the next upcoming course are represented as individual HTML slides.
- **SC-002**: Slide generation completes within 30 seconds for a typical course (up to 50 lessons with materials).
- **SC-003**: All generated slides render correctly at 1920×1080 resolution with centered content.
- **SC-004**: The `POST /api/slides` endpoint returns a success response with accurate slide count after generation.
- **SC-005**: Unauthenticated or non-admin requests to the slides endpoint are blocked (100% enforcement).

## Technical Notes

### HTML Slide Layout

All slides use a consistent base layout optimized for 1920×1080:

```html
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920">
  <title>{{pageTitle}}</title>
  <style>
    :root {
      --primary-color: #1a1a2e;
      --text-color: #ffffff;
      --font-family: system-ui, -apple-system, sans-serif;
      --bg-color: #16213e;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 1920px;
      height: 1080px;
      font-family: var(--font-family);
      background: var(--bg-color);
      color: var(--text-color);
    }
    .slide-content {
      text-align: center;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <div class="slide-content">
    {{content}}
  </div>
</body>
</html>
```

### Data Flow

```
1. POST /api/slides → authenticate → check mutex
2. GET /seminars → determine next upcoming seminar
3. Seminar data → generate 01_intro.html
4. GET /lessons → filter by seminarId → sort by sequence
5. Per lesson → generate 02_curriculum_{n}.html
6. Per lesson:
   a. GET /texts → filter by entityRef
   b. GET /media → filter by entityRef
   c. Per material → generate 03_material_{lessonSeq}_{idx}.html
7. Return success response with slide count
```

### File Structure

```
output/
  slides/
    01_intro.html
    02_curriculum_1.html
    02_curriculum_2.html
    02_curriculum_3.html
    03_material_1_1.html
    03_material_1_2.html
    03_material_2_1.html
    ...
```
